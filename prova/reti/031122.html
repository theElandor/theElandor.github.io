<!DOCTYPE html>
<head>
<title> <b>Vlan (reti), 03-12-22</b> </title>
<meta name="viewport" content="width=device-width, initial-scale=1"><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="generator" content="Org-mode"><meta name="author" content="Matteo Lugli">
<link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/tonsky/FiraCode@5.2/distr/fira_code.css">
<link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css" integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p" crossorigin="anonymous"/>
<style>
    .theme-light {
	--color-primary: black;
	--color-background: white;
	--color-text: black;
    }

    .theme-dark {
    
	--color-primary: #23b0ff;
	--color-background: #21202C;
	--color-text: white;
    }
    
    body {
	font-family: 'Fira Code', monospace;
	font-size: 20px;
	background-color: var(--color-background);
    }

    div#menu {
	position: sticky;
	position: -webkit-sticky;
	top: 5px;
	z-index: 30;
    }

    div#menu button {
	right: 0px;
	position: absolute;
    }

    p {
	color: var(--color-text);
    }

    h1, h2, h3, h4, h5, a {
	color: var(--color-primary);
    }

    nav a {
	color: var(--color-text);
    }

    nav a:hover {
	color: var(--color-primary);
	text-decoration: none;
    }

    ul li, ol li {
	color: var(--color-primary);
    }

    .collapsible {
	background-color: var(--color-background);
	border: none;
	text-align: left;
    }
    
    .top-buffer { margin-top: 18px; }

    figcaption { font-size: 15px; }

    footer { text-align: center; }

    .observation {
	border-style: solid;
	margin-top: 20px;
	margin-bottom: 20px;
    }

    pre {
	font-size: 20px;
	background-color: black;
	color: white;
	inline-size: 900px;
	overflow: auto;
	word-wrap: normal;
    }

    blockquote {
	border-left: 5px solid var(--color-primary);
    }
    .MathJax_SVG_Display{
        color:white;
    }

    blockquote p {
	color: var(--color-text);
    }

    /* side-menu stuff */
    .side-menu {
	position: fixed;
	left: 0;
	width: 60px;
	height: 100%;
	z-index: 100;
    }

    .side-menu-content {
	display: none;
	position: absolute;
	top: 60px;
	left: 0px;
	height: 100%;
	/* background-color: var(--color-primary); */
	z-index: 100;	
    }

    .side-menu-content ul {
	list-style-type: none;
	position: relative;
	margin-left: 5px;
	width: 100%;
	padding-left: 0px;
    }

    .side-menu-content ul li {
	position: relative;
	padding-top: 5px;
	font-size: 15px;
	padding-left: 0px;
    }

    .side-menu-content ul li a {
	color: var(--color-primary);
	text-decoration: none;
	font-weight: bold;
    }

    .toggle {
	position: absolute;
	display: block;
	top: 0;
	left: 0;
	width: 80px;
	height: 60px;
	background: var(--color-background);
    }

    .toggle:hover {
	background: var(--color-primary);
    }

    .toggle:before {
	content: '\f0c9';
	font-family: fontAwesome;
	position: absolute;
	width: 100%;
	height: 100%;
	line-height: 60px;
	text-align: center;
	font-size: 24px;
	color: var(--color-text);
    }

    @media (max-width: 1024px) {
	pre {
	    inline-size: 600px;
	}
    }

    @media (max-width: 576px) {
	* {
	    font-size: 10px;
	}

	h1 {
	    font-size: 13px;
	}

	h2, h3, h4, h5 {
	    font-size: 12px;
	}

	blockquote {
	    font-size: 15px;
	}

	pre, li pre {
	    font-size: 10px;
	    color: white;
	    inline-size: 300px;
	    word-wrap: normal;
	    overflow: auto;
	}

        li pre {
	    inline-size: 250px;
        }

	.toggle {
	    width: 30px;
	}

	.toggle:before {
	    content: '\f0c9';
	    font-family: fontAwesome;
	    position: absolute;
	    width: 100%;
	    height: 100%;
	    line-height: 60px;
	    text-align: center;
	    font-size: 12px;
	    color: var(--color-text);
	}	
    }


</style>

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  displayAlign: "center",
  displayIndent: "2em",
  messageStyle: "none",
  "HTML-CSS": {
    scale: 100,
    styles: {
      ".MathJax_Display": {
        "font-size": "100%"
      }
    }
  },
  "SVG": {
    scale: 100,
    styles: {
      ".MathJax_SVG_Display": {
        "font-size": "100%",
        "margin-left": "-2.281em"
      }
    }
  }
});
</script>
<script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_SVG"></script>
</head>
<body>
<div id="content" class="container">

<div class="row top-buffer"> </div>

<div class="row">
   <div class="col-xs-1"></div>
   <div class="col-xs-10"><h1 class="title"><b>Vlan (reti), 03-12-22</b></h1>
   </div>
   <div class="col-xs-1"></div>
</div> <!-- end row -->
<div class="row">
   <div class="col-xs-1"></div>
   <div class="col-xs-10"><hr style="border: 1px solid #FFFFFF" />   </div>
   <div class="col-xs-1"></div>
</div> <!-- end row -->
<div class="row">
   <div class="col-xs-1"></div>
   <div class="col-xs-10"><div id="outline-container-sec-" class="outline-2"><button type="button" class="collapsible">
<h2 id="sec-" style="text-decoration: underline">  Info &triangledown;</h2>
</button><div class='sec- collapsible-content'>
<p>
Lezione estremamente densa di contenuti, in cui è stato
spiegato il concetto di VLAN e applicato in laboratorio.
Potete contattarmi alla mia e-mail se trovate errori.
</p>
</div>
</div>
   </div>
   <div class="col-xs-1"></div>
</div> <!-- end row -->

<div class="row">
   <div class="col-xs-1"></div>
   <div class="col-xs-10"><div id="outline-container-sec-1" class="outline-2"><button type="button" class="collapsible">
<h2 id="sec-1" style="text-decoration: underline"> 1 Introduzione &triangledown;</h2>
</button><div class='sec-1 collapsible-content'>
<p>
Il concetto che sta alla base delle VLAN è
rendere indipendenti la <b>struttura fisica</b> e la
<b>struttura logica</b> di una rete.
La topologia fisica e la topologia logica possono
quindi essere configurate diversamente, in modo indipendente.
In questo modo, se si ha una rete configurata in
un certo modo <i>a livello fisico</i>, posso configurarla
logicamente nel modo che voglio proprio grazie alle VLAN.
E' un modo per suddividere i compiti durante la 
configurazione nel mondo reale di una rete.
</p>

<p>
La configurazione di VLAN è utile quando si hanno
delle reti "collassate" a livello fisico ma che 
devono essere suddivise a livello logico.
Non sempre è necessario farlo, ma soltanto quando è necessario.
</p>

<p>
Si vogliono suddividere i domini di broadcast
di host connessi allo stesso switch.
</p>
</div>
</div>
   </div>
   <div class="col-xs-1"></div>
</div> <!-- end row -->

<div class="row">
   <div class="col-xs-1"></div>
   <div class="col-xs-10"><div id="outline-container-sec-2" class="outline-2"><button type="button" class="collapsible">
<h2 id="sec-2" style="text-decoration: underline"> 2 Implementazione &triangledown;</h2>
</button><div class='sec-2 collapsible-content'>
<p>
Un requisito necessario è l'avere dei dispositivi di 
livello 2 <b>configurabili</b>: si dice allo switch/bridge
a quale VLAN inoltrare i pacchetti.
Si può immaginare che ciascuna porta sia associata a una
o più VLAN \(\rightarrow\) quando allo switch arriva
un pacchetto riesce a capire a quale VLAN è destinato!
</p>

<p>
Per implementare questo tipo di funzionalità, si può
lavorare in modi diversi, in base al livello dello stack
in cui ci si "posiziona". Vediamo ora come si può
simulare la configurazione di una VLAN: \(\downarrow\)
</p>
</div>
</div>
   </div>
   <div class="col-xs-1"></div>
</div> <!-- end row -->

<div class="row">
   <div class="col-xs-1"></div>
   <div class="col-xs-10"><div id="outline-container-sec-3" class="outline-2"><button type="button" class="collapsible">
<h2 id="sec-3" style="text-decoration: underline"> 3 LAB &triangledown;</h2>
</button><div id="outline-container-sec-3-1" class="outline-3"><button type="button" class="collapsible">
<h3 id="sec-3-1" nil> 3.1 Marrionet &triangledown;</h3>
</button><div class='sec-3-1 collapsible-content'>
<p>
Si realizza la configurazione in figura, facendo
attenzione alle porte a cui vengono collegati i cavi.
Ci si ricordi anche di spuntare "show VDE terminal" durante
la creazione dello swtich.
</p>

<p>

<div class="row top-buffer"> </div>
<img src="./vlanconfig.png"class="img-responsive"style="display: block; margin-left: auto; margin-right: auto;">
<div class="row top-buffer"> </div>

</p>
</div>
</div>
<div id="outline-container-sec-3-2" class="outline-3"><button type="button" class="collapsible">
<h3 id="sec-3-2" nil> 3.2 Configurazione IP &triangledown;</h3>
</button><div id="outline-container-sec-3-2-1" class="outline-4"><button type="button" class="collapsible">
<h4 id="sec-3-2-1" nil> 3.2.1 Configurazione temporanea &triangledown;</h4>
</button><div class='sec-3-2-1 collapsible-content'>
<p>
In questo caso usiamo IP per assegnare due indirizzi
all'interfaccia eth0 del router. Ci si deve ricordare
anche di abilitare l'ip forwarding. Per il resto, 
gli altri host si configurano normalmente.

<div class="row top-buffer"> </div>
<img src="./routerconfig.png"class="img-responsive"style="display: block; margin-left: auto; margin-right: auto;">
<div class="row top-buffer"> </div>

</p>

<p>
Attivare l'intefaccia di rete usando 
</p>

<div class="org-src-container">

<pre class="src src-sh">root@router:~# ip link set dev eth0 up
</pre>
</div>

<p>
Per poter comunicare correttamente a livello 3 è necessario
aggiungere le regole di routing ai vari host, nonostante essi
possano "parlarsi" anche a livello 2, essendo connessi allo stesso switch.
</p>

<p>
Infatti il comando <b>ping</b> per prima cosa controlla se esiste una 
regola nella tabella di routing per inviare i pacchetti, nel caso 
in cui non ci sia, viene ritornato un messaggio di errore!
</p>

<p>
Proviamo ora a posizionarci su H1 e usare il seguente comando:
</p>
<div class="org-src-container">

<pre class="src src-sh">ping 192.168.2.1
</pre>
</div>
<p>
si riceve la seguente risposta: 
</p>
<div class="org-src-container">

<pre class="src src-sh">From 192.168.1.254: <span style="color: #FFFFFF;">icmp_seq</span>=2 Redirect Host (New nexthop: 192.168.2.1)
</pre>
</div>
<p>
Si tratta di un pacchetto ICMP che indica l'individuazione di 
un "path" più breve per raggiungere il target indicato.
Infatti i due host sono connessi anche a livello 2!
Ce ne si può rendere conto usando arping, che usa il protocollo ARP
per inviare pacchetti a tutti gli host connessi alla rete locale.
</p>
<div class="org-src-container">

<pre class="src src-sh">arping -i eth0 192.168.2.1
</pre>
</div>

<p>
A tal proposito, ecco alcuni comandi utili:
</p>
<ul class="org-ul">
<li><p>
<b>ip route</b> \(\rightarrow\) fornisce le regole configurate staticamente;
</p>
</li>
<li><p>
<b>ip route get 192.168.2.1</b> --> fornisce anche informazioni 
</p>
</li>
</ul>
<p>
memorizzate in cache per il raggiungimento dell'host indicato! Infatti il messaggio ICMP accennato prima
viene "cachato" in memoria. Ecco l'output del comando: \(\Downarrow\)
</p>

<div class="org-src-container">

<pre class="src src-sh">root@H1:~# ip route get 192.168.2.1
192.168.2.1 via 192.168.2.1 dev eth0  src 192.168.1.1 
    cache &lt;redirected&gt; 
</pre>
</div>

<p>
Nel caso sia utile, ricordiamo che si può dire ad H1 che
può comunicare con H2 usando il protocollo H2N, usando
ad esempio il seguente comando: \(\Downarrow\)
</p>

<div class="org-src-container">

<pre class="src src-sh">route add -host 192.168.2.1 dev etho
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3-2-2" class="outline-4"><button type="button" class="collapsible">
<h4 id="sec-3-2-2" nil> 3.2.2 Configurazione permanente &triangledown;</h4>
</button><div class='sec-3-2-2 collapsible-content'>
<p>
Si possono usare i seguenti comandi per
resettare il router, se non si vuole spegnere la VM (utili
in sede d'esame):
</p>
<div class="org-src-container">

<pre class="src src-sh">ip addr del dev eth0 192.168.1.254/24
ip addr del dev eth0 192.168.2.254/24
ip link set dev eth0 down
</pre>
</div>

<p>
Configurazione <b>permanente</b> del router \(\downarrow\)
</p>

<pre class="example">
auto etho 
iface eth0 inet static
  address 192.168.1.254/24
  # alternativa senza alias:
  # post-up ip addr add dev eth0 192.168.2.254/24
  
iface eth0:1 inet static
  address 192.168.2.254/24
</pre>

<p>
Per configurare più indirizzi IP sulla stessa interfaccia usando
ifconfig si usa questo "trucco" che fa uso di alias:
</p>
<div class="org-src-container">

<pre class="src src-sh">ifconfig eth0 192.168.1.254/24
ifconfig eth0:1 192.168.2.254/24
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-3-3" class="outline-3"><button type="button" class="collapsible">
<h3 id="sec-3-3" nil> 3.3 VLAN &triangledown;</h3>
</button><div class='sec-3-3 collapsible-content'>
<p>
Il fatto che H1 e H2 possano comunicare a livello
2 è un problema a livello di sicurezza, ed è per
questo che entrano in gioco le VLAN!
</p>
</div>
<div id="outline-container-sec-3-3-1" class="outline-4"><button type="button" class="collapsible">
<h4 id="sec-3-3-1" nil> 3.3.1 VLAN Access Link &triangledown;</h4>
</button><div class='sec-3-3-1 collapsible-content'>
<ul class="org-ul">
<li><p>
<b>Access Link</b> \(\rightarrow\) si agisce soltanto
sullo switch, senza agire sugli host.
Le lan sono identificate da un'intero: si crea
un mapping <b>Network \(\rightarrow\) \(ID_{vlan}\)</b>
</p>
</li>
</ul>

<p>
Per creare una vlan con identificativo = 10 (arbitrario), si usa il seguente 
comando:\(\Downarrow\)
</p>
<div class="org-src-container">

<pre class="src src-sh">vlan/create 10
</pre>
</div>

<p>
Bisogna poi aggiungere le porte dello switch alla lan con identificativo 10:
</p>
<div class="org-src-container">

<pre class="src src-sh">port/setvlan 1 10
port/setvlan 3 10
</pre>
</div>

<p>
Con questo comando si stampa l'attuale configurazione dello switch:
</p>
<div class="org-src-container">

<pre class="src src-sh">vlan/print
</pre>
</div>

<p>
Ora se ci si posiziona su H1 e si prova ad usare: 
</p>
<div class="org-src-container">

<pre class="src src-sh">arping -i eth0 192.168.2.1
</pre>
</div>
<p>
vediamo che lo switch  manda delle richieste
ARP soltanto alla porta 3. Si può constatare
anche controllando le lucine dello swtich (si illuminano
ad intermittenza soltanto la \(1^o\) e la \(2^o\)).
Se ci si posiziona sul router e si usa <b>tcpdump</b>,
si vedono i pacchetti ARP inviati da H1. Il router
ovviamente non risponde a queste richieste dato che il target non è lui. 
</p>

<p>
Ora configuriamo la seconda vlan:
</p>
<div class="org-src-container">

<pre class="src src-sh">vlan/create 20
port/setvlan 2 20
</pre>
</div>
<p>
\(\Rightarrow\) <b>problema</b>: H2 non può comunicare con il router, 
dato che si trovano su vlan diverse.
\(\Rightarrow\) Possibile soluzione ("naive"):
</p>
<div class="org-src-container">

<pre class="src src-sh">port/setvlan 3 20
</pre>
</div>
<p>
in questo modo sposto il problema dall'altra parte: ora il router
non può più comunicare con H1. Questo perchè nelle
vlan access link <i>non possono essere associate diverse VLAN alla stessa porta dello switch</i>. Per risolvere
questo problema si usano le <b>VLAN tagged</b> \(\Downarrow\)
</p>
</div>
</div>
<div id="outline-container-sec-3-3-2" class="outline-4"><button type="button" class="collapsible">
<h4 id="sec-3-3-2" nil> 3.3.2 VLAN Tagged &triangledown;</h4>
</button><div class='sec-3-3-2 collapsible-content'>
<p>
Nel <b>frame ethernet</b> viene aggiunto un campo di 12 bit (tag) che
identifica la VLAN a cui il pacchetto ethernet è destinato.
</p>

<p>

<div class="row top-buffer"> </div>
<img src="./tagged.png"class="img-responsive"style="display: block; margin-left: auto; margin-right: auto;">
<div class="row top-buffer"> </div>

</p>

<p>
Con questo comando inserisco la porta 3 all'interno della
vlan 20, usando una configurazione con i tag!

<div class="row top-buffer"> </div>
<img src="./vlantagged.png"class="img-responsive"style="display: block; margin-left: auto; margin-right: auto;">
<div class="row top-buffer"> </div>

</p>
<ul class="org-ul">
<li><p>
tagged = 1 \(\rightarrow\) se sulla porta 3 lo switch riceve un frame con estensione(quindi ha il tag della vlan),
allora viene inoltrato alla VLAN 20. Se sulla porta 3 riceve un 
pacchetto <b>non taggato</b> allora esso viene associato alla VLAN 10.
</p>
</li>

<li><p>
Esempio:
un pacchetto broadcast <b>non taggato</b> arriva sulla porta 2,
e deve essere inoltrato sulla porta 3 che lavora con logica
tagged. \(\rightarrow\) lo switch <b>modifica</b> il frame
ethernet prima di inoltrarlo, in modo da mandare un 
pacchetto compatibile con la porta!
</p>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-3-3-3" class="outline-4"><button type="button" class="collapsible">
<h4 id="sec-3-3-3" nil> 3.3.3 Config permanente &triangledown;</h4>
</button><div class='sec-3-3-3 collapsible-content'>
<pre class="example">
auto eth0 eth0.20

iface eth0 inet static
  address 192.168.1.254/24
  
iface eth0.20 inet static
  address 192.168.2.254/24
</pre>
</div>
</div>
</div>
</div>
   </div>
   <div class="col-xs-1"></div>
</div> <!-- end row -->

<div class="row top-buffer"> </div>

<div class="row top-buffer"> </div>

<div class="row">
   <div class="col-xs-1"></div>
   <div class="col-xs-10"><hr style="border: 1px solid #FFFFFF" />   </div>
   <div class="col-xs-1"></div>
</div> <!-- end row -->
<div class="row">
   <div class="col-xs-1"></div>
   <div class="col-xs-10"><footer id="postamble">
<div>
<p class="author"><b>Author</b>: Matteo Lugli</p><p class="email"><b>Email</b>: <a href="mailto:matteolugli18@gmail.com">matteolugli18@gmail.com</a></p><p class="date"><b>Created</b>: 2022-11-03 Thu 18:44</p>
</div>
</footer>
   </div>
   <div class="col-xs-1"></div>
</div> <!-- end row -->
<div class="row top-buffer"> </div>

<div class="row top-buffer"> </div>

<div class="row top-buffer"> </div>
<script>

      function set_sections() {
	// -- Deal with the hiding/showing of the various sections
	var buttons = document.getElementsByClassName('collapsible');

	for (var i = 0; i < buttons.length; i++) {
	  buttons[i].addEventListener('click', function() {
	    var content = this.parentElement;
	    divs = content.getElementsByTagName('div');
	    for (var j = 0; j < divs.length; j++) {
	      if (divs[j].style.display === '' || divs[j].style.display === 'block') {
		divs[j].style.display = 'none';
	      } else {
		divs[j].style.display = 'block';
	      }
	    }
	  });
	}
      }

      function hide_sections() {
	// -- Deal with the hiding/showing of the various sections
	var buttons = document.getElementsByClassName('collapsible');
	var sections_to_not_hide = ['Lecture Info', 'Overview', 'Basic Info', 'Informazioni Lezione', 'Table of Contents', 'Informazioni', 'Lecture Summary']

	for (var i = 0; i < buttons.length; i++) {
	  // -- Check which sections to hide initially
	  html_elem = buttons[i].getElementsByTagName('h2').length > 0 ?
	    buttons[i].getElementsByTagName('h2')[0] :
	    buttons[i].getElementsByTagName('h3').length > 0 ?
	    buttons[i].getElementsByTagName('h3')[0] :
	    buttons[i].getElementsByTagName('h4')[0];

	  var hide_section = true;

	  for (var h = 0; h < sections_to_not_hide.length; h++) {
	    if (html_elem.innerHTML.includes(sections_to_not_hide[h])) {
	      hide_section = false;
	    }
	  }

	  if (hide_section) {
	    divs = buttons[i].parentElement.getElementsByTagName('div');

	    for (var j = 0; j < divs.length; j++) {
	      divs[j].style.display =
		divs[j].style.display === '' || divs[j].style.display === 'block' ?
		divs[j].style.display = 'none' :
		divs[j].style.display = 'block';
	    }
	  }    
	}
      }

      // ---------------------------

      // function to set a given theme/color-scheme
      function setTheme(themeName) {
        localStorage.setItem('theme', themeName);
        document.documentElement.className = themeName;
      }

      // function to toggle between light and dark theme
      function toggleTheme() {
        if (localStorage.getItem('theme') === 'theme-dark') {
          setTheme('theme-light');
        } else {
          setTheme('theme-dark');
        }
      }

      // Immediately invoked function to set the theme on initial load
      (function () {
        if (localStorage.getItem('theme') === 'theme-light') {
          setTheme('theme-light');
        } else {
          setTheme('theme-dark');
        }
      })();
      

      // ---------------------------

      // toggle menu
      var menu_off = 1
      
      function toggleMenu() {
	let menu = document.querySelector('.side-menu');
	let menu_list = document.querySelector('.side-menu-content');
	let toggle = document.querySelector('.toggle');

	let inactive_color = getComputedStyle(document.body)
	    .getPropertyValue('--color-background');

	let active_color = getComputedStyle(document.body)
	    .getPropertyValue('--color-primary');	
		
	if (menu_off) {
	  // activate menu
	  toggle.style.backgroundColor = active_color;
	  menu.style.width = '170px';
	  menu_list.style.display = 'block';
	  menu_off = 0;
	} else {
	  // de-activate menu
	  toggle.style.backgroundColor = inactive_color;
	  menu.style.width = '60px';	  
	  menu_list.style.display = 'none';
	  menu_off = 1;
	}
      }

set_sections();
hide_sections();
</script>
</div>
</body>
</html>
